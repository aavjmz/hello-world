# CAN Analyzer 用户手册

**版本:** v0.9.0
**更新日期:** 2025-11-08

---

## 📖 目录

1. [快速入门](#快速入门)
2. [基础功能](#基础功能)
   - [导入CAN报文](#导入can报文)
   - [查看报文数据](#查看报文数据)
   - [时间戳格式](#时间戳格式)
3. [DBC数据库管理](#dbc数据库管理)
   - [导入DBC文件](#导入dbc文件)
   - [管理DBC数据库](#管理dbc数据库)
   - [信号解码](#信号解码)
4. [高级功能](#高级功能)
   - [报文过滤](#报文过滤)
   - [报文搜索](#报文搜索)
   - [信号可视化](#信号可视化)
   - [数据导出](#数据导出)
5. [快捷键参考](#快捷键参考)
6. [常见问题FAQ](#常见问题faq)
7. [使用技巧](#使用技巧)

---

## 快速入门

### 安装与运行

1. **安装依赖**
   ```bash
   cd can_analyzer
   pip install -r requirements.txt
   ```

2. **启动程序**
   ```bash
   python main.py
   ```
   或
   ```bash
   python -m can_analyzer
   ```

### 5分钟入门流程

1. **导入报文文件**: 文件 → 导入报文 (Ctrl+I)
2. **导入DBC文件**: DBC → 导入DBC
3. **查看解码后的信号**: 报文表格最后一列显示信号值
4. **绘制信号曲线**: 视图 → 新建视图 (Ctrl+T)
5. **导出数据**: 文件 → 导出报文 (Ctrl+E)

---

## 基础功能

### 导入CAN报文

#### 支持的文件格式

- **ASC格式** (.asc) - Vector CANalyzer/CANoe格式
- **BLF格式** (.blf) - Binary Logging Format
- **LOG格式** (.log) - 通用日志格式

#### 导入步骤

1. **打开导入对话框**
   - 菜单: 文件 → 导入报文
   - 工具栏: 点击"导入报文"按钮
   - 快捷键: **Ctrl+I**

2. **选择文件**
   - 浏览并选择CAN报文文件
   - 程序会自动检测文件格式

3. **后台导入**
   - 文件在后台线程中导入
   - 进度对话框显示导入进度
   - 主界面保持响应，可以移动窗口

4. **查看结果**
   - 导入完成后，报文显示在左侧表格中
   - 状态栏显示报文统计信息

#### 导入大文件优化

- ✅ 后台线程导入，不阻塞UI
- ✅ 进度实时显示（0-100%）
- ✅ 批量加载显示（100行/批）
- ✅ 可取消导入操作

---

### 查看报文数据

#### 报文表格列说明

| 列名 | 说明 |
|------|------|
| **序号** | 报文在文件中的序号（从1开始） |
| **时间戳** | 报文时间戳（可切换格式） |
| **通道** | CAN通道编号 |
| **CAN ID** | CAN标识符（十六进制显示，如0x123） |
| **方向** | Rx（接收）或Tx（发送） |
| **DLC** | 数据长度（0-8字节） |
| **数据** | 报文数据（十六进制，空格分隔） |
| **信号值** | 解码后的信号值（需要DBC） |

#### 颜色编码

- **绿色**: Rx（接收报文）
- **蓝色**: Tx（发送报文）
- **青色**: 信号值列
- **黄色高亮**: 搜索结果

#### 表格操作

- **单击行**: 选中报文
- **双击行**: 查看报文详情（预留功能）
- **右键菜单**:
  - 复制报文数据
  - 切换时间戳格式

---

### 时间戳格式

#### 6种时间戳格式

1. **原始格式** (默认)
   - 格式: 秒，保留6位小数
   - 示例: `1.234567`

2. **秒格式**
   - 格式: 整数秒
   - 示例: `1`

3. **毫秒格式**
   - 格式: 整数毫秒
   - 示例: `1235`

4. **微秒格式**
   - 格式: 整数微秒
   - 示例: `1234567`

5. **绝对时间**
   - 格式: HH:MM:SS.mmm
   - 示例: `00:00:01.235`

6. **相对时间**
   - 格式: 相对于第一条报文的时间
   - 示例: `+0.100000`

#### 切换时间戳格式

- 右键点击表格 → 时间戳格式 → 选择格式

---

## DBC数据库管理

### 导入DBC文件

#### 什么是DBC文件？

DBC (Database Container) 文件定义了CAN报文的结构和信号编码规则，包括：
- 报文定义（ID、名称、长度）
- 信号定义（名称、位置、长度、比例、偏移）
- 信号值描述（枚举值）
- 节点定义

#### 导入步骤

1. **打开导入对话框**
   - 菜单: DBC → 导入DBC
   - 工具栏: 点击"导入DBC"按钮

2. **选择DBC文件**
   - 浏览并选择.dbc文件
   - 支持同时加载多个DBC文件

3. **查看导入结果**
   - 成功: 显示包含的消息数和信号数
   - 失败: 显示错误信息

---

### 管理DBC数据库

#### 打开DBC管理器

- 菜单: DBC → 管理DBC

#### 管理器界面

**左侧 - DBC列表**
- 显示所有已加载的DBC文件
- ★ 标记表示当前激活的DBC

**右侧 - 详细信息**
- **文件信息**: 路径、激活状态
- **统计信息**: 消息数、节点数、信号数
- **消息列表**: DBC中定义的所有消息
- **信号列表**: DBC中定义的所有信号

#### 操作按钮

- **添加**: 导入新的DBC文件
- **删除**: 移除选中的DBC文件
- **激活**: 设置选中的DBC为当前激活

#### 激活状态

- ⚠️ **同一时间只能有一个DBC处于激活状态**
- 只有激活的DBC用于信号解码
- 切换激活DBC后，表格会自动刷新显示

---

### 信号解码

#### 自动解码

当满足以下条件时，信号会自动解码：
1. ✅ 已导入DBC文件
2. ✅ DBC处于激活状态
3. ✅ DBC中定义了该CAN ID的消息

#### 信号值显示

- **位置**: 报文表格最后一列
- **格式**: `信号名: 物理值单位, ...`
- **示例**: `EngineSpeed: 2000rpm, EngineTemp: 90°C`

#### 物理值转换

- 原始值 → 物理值公式: `物理值 = 原始值 × 比例因子 + 偏移量`
- 自动应用DBC中定义的比例和偏移
- 自动添加单位（如rpm、km/h、°C等）

---

## 高级功能

### 报文过滤

#### 打开过滤器

- 菜单: 工具 → 过滤器

#### 4种过滤条件

**1. CAN ID过滤**
- **包含模式**: 只显示指定的ID
- **排除模式**: 隐藏指定的ID
- **输入格式**:
  - 十六进制: `123` 或 `0x123`
  - 多个ID: 逗号或空格分隔

**2. 方向过滤**
- ☑️ Rx - 显示接收报文
- ☑️ Tx - 显示发送报文
- 可同时选择或单独选择

**3. 时间范围过滤**
- 起始时间: 设置开始时间（秒）
- 结束时间: 设置结束时间（秒）
- 精度: 0.001秒

**4. DLC过滤**
- 最小DLC: 0-8字节
- 最大DLC: 0-8字节

#### 过滤器操作

- **应用**: 应用过滤条件
- **清除所有**: 清除所有过滤条件
- **取消**: 关闭对话框

#### 过滤器状态

- 激活时，状态栏显示过滤信息
- 格式: `显示 X/Y 条报文 | 过滤条件描述`

---

### 报文搜索

#### 打开搜索对话框

- 菜单: 工具 → 搜索报文
- 快捷键: **Ctrl+F**

#### 3种搜索类型

**1. CAN ID搜索**
- 按CAN标识符搜索
- 支持格式: `123` 或 `0x123`
- 精确匹配

**2. 数据内容搜索**
- 按报文数据搜索
- 支持格式: `01 02 03` 或 `010203`
- 十六进制，部分匹配
- 不区分大小写

**3. 信号值搜索**
- 按信号名称或值搜索
- 示例: `EngineSpeed` 或 `2000`
- 需要DBC文件

#### 搜索选项

- ☑️ 区分大小写
- ☑️ 全字匹配

#### 搜索导航

- **下一个** (F3): 查找下一个匹配项
- **上一个** (Shift+F3): 查找上一个匹配项
- **循环查找**: 到达末尾后自动回到开头

#### 搜索结果

- 找到的报文会**黄色高亮**显示
- 自动滚动到结果位置
- 状态栏显示位置信息

---

### 信号可视化

#### 创建新视图

1. **前提条件**
   - ✅ 已导入报文
   - ✅ 已导入并激活DBC

2. **打开信号选择对话框**
   - 菜单: 视图 → 新建视图
   - 工具栏: 点击"新建视图"按钮
   - 快捷键: **Ctrl+T**

3. **选择信号**
   - 勾选要绘制的信号
   - 可选择多个信号叠加显示
   - 显示格式: `消息.信号 (单位) [ID]`

4. **创建曲线**
   - 点击"确定"生成曲线图
   - 新视图作为标签页显示在右侧

#### 曲线图功能

**自动功能**
- ✅ 自动颜色分配（10种颜色循环）
- ✅ 图例显示
- ✅ 网格显示
- ✅ 自适应坐标范围

**交互操作**
- **缩放**: 鼠标滚轮 或 框选区域
- **平移**: 鼠标拖动
- **图例**: 点击图例隐藏/显示信号
- **重置**: 双击图表区域

#### 双后端支持

1. **PyQtGraph** (首选)
   - 高性能
   - 流畅交互
   - 适合大量数据

2. **Matplotlib** (备选)
   - 通用绘图库
   - 当PyQtGraph不可用时自动使用

#### 管理视图

- **多标签页**: 可创建多个视图
- **关闭标签**: 点击标签页的 × 按钮
- **切换标签**: 点击标签名称

---

### 数据导出

#### 打开导出对话框

- 菜单: 文件 → 导出报文
- 快捷键: **Ctrl+E**

#### 3种导出格式

**1. CSV (逗号分隔值)**
- 文件扩展名: `.csv`
- 优点:
  - 可在Excel、Numbers等软件中打开
  - 文件小，加载快
  - 通用性好
- 适用场景: 数据分析、表格查看

**2. Excel (*.xlsx)**
- 文件扩展名: `.xlsx`
- 优点:
  - 带格式化样式（颜色、字体）
  - 自动列宽调整
  - 专业外观
- 要求: 需要安装 `openpyxl` 库
  ```bash
  pip install openpyxl
  ```

**3. JSON (JavaScript对象表示法)**
- 文件扩展名: `.json`
- 优点:
  - 结构化数据
  - 易于编程处理
  - 包含元数据信息
- 适用场景: 程序处理、API集成

#### 导出范围

- **导出所有报文**: 导出原始文件的所有报文
- **仅导出过滤后的报文**: 只导出符合当前过滤条件的报文

#### 导出选项

- ☑️ **包含信号解码值**: 导出信号的物理值（需要DBC）
- ☑️ **格式化JSON输出**: 添加缩进和换行（JSON格式）

#### 导出统计

对话框底部实时显示:
- 报文总数
- 唯一ID数量
- Rx/Tx数量
- 时间跨度

#### 导出进度

- 显示导出进度
- 可取消导出操作

---

## 快捷键参考

| 功能 | 快捷键 |
|------|--------|
| **导入报文** | Ctrl+I |
| **导出报文** | Ctrl+E |
| **搜索报文** | Ctrl+F |
| **下一个搜索结果** | F3 |
| **上一个搜索结果** | Shift+F3 |
| **新建视图** | Ctrl+T |
| **退出程序** | Ctrl+Q |

---

## 常见问题FAQ

### 安装与运行

**Q: 如何安装CAN Analyzer？**

A:
```bash
cd can_analyzer
pip install -r requirements.txt
python main.py
```

**Q: 启动时报错"ModuleNotFoundError"？**

A: 检查是否安装了所有依赖：
```bash
pip install PyQt6 cantools python-can pyqtgraph matplotlib numpy
```

---

### 文件导入

**Q: 支持哪些文件格式？**

A:
- ✅ ASC (.asc) - Vector格式
- ✅ BLF (.blf) - 二进制格式
- ✅ LOG (.log) - 通用日志

**Q: 导入BLF文件失败，提示"is_tx"错误？**

A: 这个问题已在v0.8修复。如果仍然出现，请更新到最新版本。

**Q: 导入大文件时程序无响应？**

A: v0.8已优化：
- 后台线程导入
- 批量加载显示
- 不会阻塞UI

---

### DBC数据库

**Q: 如何知道DBC是否正确加载？**

A:
1. 导入成功会显示消息数和信号数
2. 在DBC管理器中可以看到★标记
3. 报文表格最后一列显示信号值

**Q: 为什么导入了DBC但没有信号值？**

A: 检查以下几点：
1. DBC是否处于激活状态（★标记）
2. DBC中是否定义了对应CAN ID的消息
3. DBC文件版本是否匹配

**Q: 可以同时使用多个DBC吗？**

A: 可以加载多个DBC，但**同一时间只能激活一个**用于解码。

---

### 信号可视化

**Q: 创建视图时没有可选信号？**

A: 确认：
1. 已导入报文文件
2. 已导入并激活DBC
3. DBC中包含报文对应的信号定义

**Q: 信号曲线图中文显示乱码？**

A: v0.8已修复中文字体问题。确保系统安装了以下字体之一：
- Microsoft YaHei
- SimHei
- STHeiti
- PingFang SC

**Q: 可以同时显示多少个信号？**

A: 理论上无限制，但建议不超过10个以保持清晰度。

---

### 过滤与搜索

**Q: 过滤器和搜索的区别？**

A:
- **过滤器**: 限制显示的报文范围（持久性）
- **搜索**: 在当前显示的报文中查找（临时性）

**Q: 如何清除过滤器？**

A:
1. 工具 → 过滤器
2. 点击"清除所有"按钮

**Q: 搜索支持正则表达式吗？**

A: 当前版本不支持，计划在v1.0中添加。

---

### 数据导出

**Q: 导出Excel格式失败？**

A: Excel格式需要`openpyxl`库：
```bash
pip install openpyxl
```

**Q: 导出的CSV文件乱码？**

A: CAN Analyzer使用UTF-8编码。在Excel中打开CSV：
1. Excel → 数据 → 从文本/CSV
2. 选择UTF-8编码
3. 导入数据

**Q: 导出时可以选择特定字段吗？**

A: 当前版本导出所有字段。自定义字段功能计划在v1.0中添加。

---

## 使用技巧

### 技巧1: 快速查看特定ID的报文

1. 使用过滤器设置ID（包含模式）
2. 只显示关心的报文
3. 大大提升查看效率

### 技巧2: 对比两个时间段的信号

1. 使用时间范围过滤器选择第一段
2. 创建信号视图并截图
3. 清除过滤器，选择第二段
4. 创建新视图对比

### 技巧3: 快速定位异常报文

1. 使用搜索功能按数据内容查找
2. 例如搜索 `FF FF FF` 找到可能的错误帧
3. 黄色高亮快速识别

### 技巧4: 批量导出不同格式

1. CSV用于Excel分析
2. JSON用于程序处理
3. Excel用于生成报告

### 技巧5: 优化大文件处理

- 先用过滤器缩小范围
- 再进行搜索或可视化
- 减少处理数据量，提升性能

### 技巧6: 时间戳格式选择

- **调试**: 使用原始格式（精确）
- **分析**: 使用毫秒格式（易读）
- **对比**: 使用相对时间（清晰）

### 技巧7: 快捷键组合使用

```
Ctrl+I (导入) → Ctrl+F (搜索) → F3 (下一个) → Ctrl+E (导出)
```

---

## 技术支持

**遇到问题？**

1. 查看本手册的[常见问题FAQ](#常见问题faq)
2. 检查[GitHub Issues](https://github.com/your-repo/issues)
3. 提交新的Issue并附带:
   - 错误信息截图
   - 操作步骤
   - 系统环境信息

**功能建议？**

欢迎通过GitHub Issues提交功能请求！

---

## 更新日志

### v0.9.0 (2025-11-08)
- ✅ 新增报文搜索功能（Ctrl+F）
- ✅ 新增数据导出功能（CSV/Excel/JSON）
- ✅ 新增用户手册文档

### v0.8.0-beta (2025-11-05)
- ✅ 修复中文字体显示问题
- ✅ 修复BLF解析错误
- ✅ 优化UI响应性能
- ✅ 修复多信号显示问题

---

**感谢使用 CAN Analyzer！** 🚗📊
